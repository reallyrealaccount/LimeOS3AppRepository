name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  read-json:
    runs-on: ubuntu-latest
    outputs:
      json-content: ${{ steps.file.outputs.content }}
    steps:
      - uses: actions/checkout@v4

      - name: Read the file
        id: file
        uses: juliangruber/read-file-action@v1
        with:
          path: ./apps.json

  loop-json:
    runs-on: ubuntu-latest
    needs: read-json
    steps:
      - name: Checkout
        uses: actions/checkout@v1

      - name: Create JSON Objects
        run: |
          echo "[" > combined.json
          for app in $(echo '${{ needs.read-json.outputs.json-content }}' | jq -c '.[]'); do
            echo "$app," >> combined.json
          done
          # Remove the last comma
          sed -i '$ s/,$//' combined.json
          echo "]" >> combined.json

      - name: Upload JSON as artifact
        uses: actions/upload-artifact@v3
        with:
          name: combined-json
          path: combined.json

  finalise:
    runs-on: ubuntu-latest
    needs: loop-json
    steps:
      - name: Download Outputs
        uses: actions/download-artifact@v3
        with:
          name: combined-json

      - run: |
          cat combined.json
